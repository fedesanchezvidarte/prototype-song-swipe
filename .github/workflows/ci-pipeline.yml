name: Song Swipe Frontend CI Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Code checkout
        uses: actions/checkout@v4
      
      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'
      
      - name: Grant permissions to gradlew
        run: chmod +x ./gradlew
      
      - name: Clean CI environment
        run: |
          rm -f local.properties
          rm -f gradle.properties
      
      - name: Create CI gradle.properties
        run: |
          cat > gradle.properties << EOF
          org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8
          android.useAndroidX=true
          kotlin.code.style=official
          android.nonTransitiveRClass=true
          EOF
      
      - name: Build with Gradle
        run: ./gradlew assembleDebug --stacktrace
      
      - name: Run unit tests
        run: ./gradlew test --stacktrace --continue
      
      - name: Upload test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports
          path: |
            **/build/reports/tests/**
            **/build/test-results/**
          retention-days: 30
      
      - name: Test summary
        if: always()
        run: |
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Find all test result XML files from debugUnitTest only (avoid counting twice)
          TEST_DIR="./app/build/test-results/testDebugUnitTest"
          
          if [ ! -d "$TEST_DIR" ]; then
            echo "⚠️ No test results found in $TEST_DIR" >> $GITHUB_STEP_SUMMARY
          else
            TOTAL=0
            FAILED=0
            SKIPPED=0
            FILE_COUNT=0
            
            # Aggregate counts from all TEST-*.xml files
            for file in "$TEST_DIR"/TEST-*.xml; do
              if [ -f "$file" ]; then
                FILE_COUNT=$((FILE_COUNT + 1))
                
                # Extract counts from this file
                T=$(grep -o 'tests="[0-9]*"' "$file" | head -1 | grep -o '[0-9]*')
                F=$(grep -o 'failures="[0-9]*"' "$file" | head -1 | grep -o '[0-9]*')
                S=$(grep -o 'skipped="[0-9]*"' "$file" | head -1 | grep -o '[0-9]*')
                
                TOTAL=$((TOTAL + ${T:-0}))
                FAILED=$((FAILED + ${F:-0}))
                SKIPPED=$((SKIPPED + ${S:-0}))
              fi
            done
            
            PASSED=$((TOTAL - FAILED - SKIPPED))
            
            echo "Processed $FILE_COUNT test result files" >&2
            
            echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| ✅ Passed | $PASSED |" >> $GITHUB_STEP_SUMMARY
            echo "| ❌ Failed | $FAILED |" >> $GITHUB_STEP_SUMMARY
            echo "| ⏭️ Skipped | $SKIPPED |" >> $GITHUB_STEP_SUMMARY
            echo "| **Total** | **$TOTAL** |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ $FAILED -gt 0 ]; then
              echo "❌ **Build Status:** Tests failed" >> $GITHUB_STEP_SUMMARY
              exit 1
            else
              echo "✅ **Build Status:** All tests passed" >> $GITHUB_STEP_SUMMARY
            fi
          fi