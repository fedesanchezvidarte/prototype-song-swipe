name: Song Swipe Frontend CI Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Code checkout
        uses: actions/checkout@v4
      
      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'
      
      - name: Grant permissions to gradlew
        run: chmod +x ./gradlew
      
      - name: Clean CI environment
        run: |
          rm -f local.properties
          rm -f gradle.properties
      
      - name: Create CI gradle.properties
        run: |
          cat > gradle.properties << EOF
          org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8
          android.useAndroidX=true
          kotlin.code.style=official
          android.nonTransitiveRClass=true
          EOF
      
      - name: Build with Gradle
        run: ./gradlew assembleDebug --stacktrace
      
      - name: Run unit tests
        run: ./gradlew test --stacktrace --continue
      
      - name: Upload test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports
          path: |
            **/build/reports/tests/**
            **/build/test-results/**
          retention-days: 30
      
      - name: Test summary
        if: always()
        run: |
          echo "## Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Find aggregated test result file (avoid counting the same tests multiple times)
          TEST_FILE=$(find . -path "*/testDebugUnitTest/*" -name "TEST-*.xml" 2>/dev/null | head -1)
          
          if [ -z "$TEST_FILE" ]; then
            echo "⚠️ No test results found" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Searched for test result files in:" >> $GITHUB_STEP_SUMMARY
            find . -type d -name "test-results" 2>/dev/null | head -3 >> $GITHUB_STEP_SUMMARY || echo "No test-results directories found" >> $GITHUB_STEP_SUMMARY
          else
            echo "Found test results in: $TEST_FILE" >&2
            
            # Extract test counts using sed
            TOTAL=$(sed -n 's/.*tests="\([0-9]*\)".*/\1/p' "$TEST_FILE" | head -1)
            FAILED=$(sed -n 's/.*failures="\([0-9]*\)".*/\1/p' "$TEST_FILE" | head -1)
            SKIPPED=$(sed -n 's/.*skipped="\([0-9]*\)".*/\1/p' "$TEST_FILE" | head -1)
            
            # Default to 0 if empty
            TOTAL=${TOTAL:-0}
            FAILED=${FAILED:-0}
            SKIPPED=${SKIPPED:-0}
            PASSED=$((TOTAL - FAILED - SKIPPED))
            
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| **Passed** | $PASSED |" >> $GITHUB_STEP_SUMMARY
            echo "| **Failed** | $FAILED |" >> $GITHUB_STEP_SUMMARY
            echo "| **Skipped** | $SKIPPED |" >> $GITHUB_STEP_SUMMARY
            echo "| **Total** | $TOTAL |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ $FAILED -gt 0 ]; then
              echo "❌ **Build Status:** Tests failed" >> $GITHUB_STEP_SUMMARY
              exit 1
            else
              echo "✅ **Build Status:** All tests passed" >> $GITHUB_STEP_SUMMARY
            fi
          fi