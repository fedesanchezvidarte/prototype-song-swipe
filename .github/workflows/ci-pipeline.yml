name: Song Swipe Frontend CI Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  build-and-test:
    name: Build and Test
    runs-on: ubuntu-latest
    
    steps:
      - name: Code checkout
        uses: actions/checkout@v4
      
      - name: Setup JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'
      
      - name: Grant permissions to gradlew
        run: chmod +x ./gradlew
      
      - name: Clean CI environment
        run: |
          rm -f local.properties
          rm -f gradle.properties
      
      - name: Create CI gradle.properties
        run: |
          cat > gradle.properties << EOF
          org.gradle.jvmargs=-Xmx2048m -Dfile.encoding=UTF-8
          android.useAndroidX=true
          kotlin.code.style=official
          android.nonTransitiveRClass=true
          EOF
      
      - name: Build with Gradle
        run: ./gradlew assembleDebug --stacktrace
      
      - name: Run unit tests
        run: ./gradlew test --stacktrace --continue
      
      - name: Upload test reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-reports
          path: |
            **/build/reports/tests/**
            **/build/test-results/**
          retention-days: 30
      
      - name: Test summary
        if: always()
        run: |
          echo "## ðŸ“Š Test Results Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Find all test result XML files
          TEST_FILES=$(find . -path "*/build/test-results/*/TEST-*.xml" 2>/dev/null || echo "")
          
          if [ -z "$TEST_FILES" ]; then
            echo "âš ï¸ No test results found" >> $GITHUB_STEP_SUMMARY
          else
            TOTAL=0
            PASSED=0
            FAILED=0
            SKIPPED=0
            
            for file in $TEST_FILES; do
              if [ -f "$file" ]; then
                TESTS=$(grep -oP 'tests="\K[0-9]+' "$file" | head -1 || echo "0")
                FAILURES=$(grep -oP 'failures="\K[0-9]+' "$file" | head -1 || echo "0")
                SKIPS=$(grep -oP 'skipped="\K[0-9]+' "$file" | head -1 || echo "0")
                
                TOTAL=$((TOTAL + TESTS))
                FAILED=$((FAILED + FAILURES))
                SKIPPED=$((SKIPPED + SKIPS))
              fi
            done
            
            PASSED=$((TOTAL - FAILED - SKIPPED))
            
            echo "| Metric | Count |" >> $GITHUB_STEP_SUMMARY
            echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
            echo "| âœ… **Passed** | $PASSED |" >> $GITHUB_STEP_SUMMARY
            echo "| âŒ **Failed** | $FAILED |" >> $GITHUB_STEP_SUMMARY
            echo "| â­ï¸ **Skipped** | $SKIPPED |" >> $GITHUB_STEP_SUMMARY
            echo "| ðŸ“ **Total** | $TOTAL |" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            
            if [ $FAILED -gt 0 ]; then
              echo "âŒ **Build Status:** Tests failed" >> $GITHUB_STEP_SUMMARY
              exit 1
            else
              echo "âœ… **Build Status:** All tests passed" >> $GITHUB_STEP_SUMMARY
            fi
          fi